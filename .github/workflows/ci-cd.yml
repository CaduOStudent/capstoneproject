# .github/workflows/ci-cd.yml
name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  # 1. Lint & test Helm chart
  chart-testing:
    uses: ./.github/workflows/chart-testing.yml
    with:
      chart-path: bookcatalog-chart
      helm-version: v3.14.0
      ct-version: 3.10.0
      # kubeconfig: ${{ secrets.KUBE_CONFIG }}  # optional

  # 2. Run Django tests
  run-django-tests:
    needs: chart-testing
    uses: ./.github/workflows/django-tests.yml
    with:
      python-version: 3.10
    secrets:
      POSTGRES_URL: ${{ secrets.POSTGRES_URL }}

  # 3. Semantic release
  release:
    needs: run-django-tests
    uses: ./.github/workflows/release.yml
    secrets:
      github_token: ${{ secrets.GITHUB_TOKEN }}

  # 4. Build & push Docker image
  build-docker-image:
    needs: release
    uses: ./.github/workflows/docker-build.yml
    with:
      image-tag: ${{ needs.release.outputs.new-release-version }}
    secrets:
      github_token: ${{ secrets.GITHUB_TOKEN }}

  # 5. Bump Helm chart values for GitOps
  deploy-application:
    name: Deploy via GitOps
    needs: [ release, build-docker-image ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update production values.yaml
        uses: fjogeleit/yaml-update-action@main
        with:
          valueFile: envs/production/values.yaml
          propertyPath: image.tag
          value: ${{ needs.release.outputs.new-release-version }}
          commitChange: true
          message: |
            chore: Deploy Image ${{ needs.release.outputs.new-release-version }} [skip ci]